name: Deploy HonKit

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Nécessaire pour peaceiris (si utilisé)
      pages: write
      id-token: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'  # ← IMPORTANT: Node.js 18 minimum
        
    - name: Check for required files
      run: |
        echo "Vérification des fichiers requis..."
        ls -la
        if [ ! -f "SUMMARY.md" ]; then
          echo "❌ SUMMARY.md manquant - création d'un fichier minimal"
          echo "# Summary" > SUMMARY.md
          echo "" >> SUMMARY.md
          echo "* [Introduction](README.md)" >> SUMMARY.md
        fi
        if [ ! -f "README.md" ]; then
          echo "❌ README.md manquant - création d'un fichier minimal"
          echo "# Documentation" > README.md
          echo "" >> README.md
          echo "Bienvenue dans la documentation." >> README.md
        fi
        echo "✅ Fichiers vérifiés"
        
    - name: Install HonKit
      run: |
        echo "Installation de HonKit avec Node.js $(node --version)..."
        npm install -g honkit
        honkit --version
        
    - name: Build book
      run: |
        echo "Construction du livre..."
        honkit build --log=debug
        echo "✅ Construction terminée"
        ls -la _book/
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./_book
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
